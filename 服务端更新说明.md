# 服务端 LocalStorage 功能更新说明

## 新增功能

服务端已成功添加了对LocalStorage的支持，现在可以同时处理cookies和localStorage数据。

## 新增API端点

### 1. 发送 Cookies + LocalStorage
- **端点**: `POST /{PATH_SECRET}/send-cookies-storage`
- **功能**: 同时保存cookies和localStorage数据
- **请求体**:
```json
{
  "id": "cookie_id",
  "url": "https://example.com",
  "cookies": [...],
  "localStorage": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

### 2. 接收 Cookies + LocalStorage
- **端点**: `GET /{PATH_SECRET}/receive-cookies-storage/{id}`
- **功能**: 同时获取cookies和localStorage数据
- **响应**:
```json
{
  "success": true,
  "cookies": [...],
  "localStorage": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

## 数据存储格式

现在存储的数据格式已更新为：
```json
{
  "id": "cookie_id",
  "url": "https://example.com",
  "cookies": [...],
  "localStorage": {
    "720yun_v8_session": "...",
    "720yun_v8_session_expiry": "...",
    "720yun_v8_token": "..."
  }
}
```

## 管理界面更新

### 新增功能
1. **LocalStorage输入框**: 在创建Cookie时可以选择性添加localStorage数据
2. **双重创建按钮**: 
   - "创建 Cookie" - 只保存cookies
   - "创建 Cookie + LocalStorage" - 同时保存cookies和localStorage
3. **类型显示**: 在列表中显示每个条目是"Cookie Only"还是"Cookie + LocalStorage"

### 使用示例

#### 创建720yun的完整登录状态
```json
// Cookies (JSON格式)
[
  {
    "name": "session_id",
    "value": "abc123",
    "domain": "720yun.com",
    "path": "/",
    "secure": true,
    "httpOnly": true,
    "sameSite": "strict"
  }
]

// LocalStorage (JSON格式)
{
  "720yun_v8_session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "720yun_v8_session_expiry": "2024-12-31T23:59:59.000Z",
  "720yun_v8_token": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## 兼容性

### 向后兼容
- 原有的 `/send-cookies` 和 `/receive-cookies/{id}` 端点继续正常工作
- 没有localStorage的旧数据仍然可以正常读取
- 客户端可以选择使用哪个端点

### 数据迁移
- 现有数据无需迁移
- 新数据会自动包含localStorage字段（如果提供）
- 旧数据读取时会返回空的localStorage对象

## 错误处理

### 新增验证
1. **localStorage格式验证**: 确保localStorage是有效的对象
2. **数据完整性检查**: 验证cookies和localStorage的格式
3. **错误消息**: 提供更详细的错误信息

### 常见错误
- `"Invalid localStorage format"` - localStorage不是有效对象
- `"Cookies and localStorage not found"` - 请求的ID不存在

## 测试建议

### 1. 基本功能测试
```bash
# 发送cookies和localStorage
curl -X POST "https://your-domain.com/{PATH_SECRET}/send-cookies-storage" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test123",
    "url": "https://720yun.com",
    "cookies": [...],
    "localStorage": {"test": "value"}
  }'

# 接收cookies和localStorage
curl "https://your-domain.com/{PATH_SECRET}/receive-cookies-storage/test123"
```

### 2. 管理界面测试
1. 访问管理页面
2. 输入管理员密码
3. 测试创建包含localStorage的Cookie
4. 验证列表中显示正确的类型信息

### 3. 客户端集成测试
1. 在720yun网站测试插件功能
2. 验证localStorage数据是否正确传输
3. 检查登录状态是否完整恢复

## 部署注意事项

1. **重新部署**: 需要重新部署worker以应用更新
2. **环境变量**: 确保PATH_SECRET等环境变量正确设置
3. **权限检查**: 验证管理员密码功能正常工作
4. **监控**: 观察API调用日志确保新端点正常工作

## 性能影响

- **存储空间**: 包含localStorage的数据会占用更多存储空间
- **传输时间**: 数据传输时间略有增加
- **处理时间**: 服务器处理时间基本无影响

现在服务端已经完全支持LocalStorage功能，可以与更新后的Chrome插件完美配合使用！
